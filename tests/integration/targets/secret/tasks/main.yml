---
- vars:
    api_key: "{{ API_KEY }}"
    api_host: "{{ API_HOST }}"
    project_id: "{{ PROJECT_ID }}"
    region_id: "{{ REGION_ID }}"
    secret_name: "test_ansible_secret"
    secret_payload: "aGVsbG8sIHRlc3Qgc3RyaW5nCg=="
    payload_content_encoding: "base64"
    payload_content_type: "application/octet-stream"
    secret_type: "certificate"

  block:
    - name: Create new secret
      gcore.cloud.secret:
        api_key: "{{ api_key }}"
        api_host: "{{ api_host }}"
        project_id: "{{ project_id }}"
        region_id: "{{ region_id }}"
        command: create
        name: "{{ secret_name }}"
        payload: "{{ secret_payload }}"
        payload_content_encoding: "{{ payload_content_encoding }}"
        payload_content_type: "{{ payload_content_type }}"
        secret_type: "{{ secret_type }}"
      register: created_secret
    - name: Verify secret
      ansible.builtin.assert:
        that:
          - created_secret.data.name == "{{ secret_name }}"
          - created_secret.data.content_types.default == "{{ payload_content_type }}"
          - created_secret.data.secret_type == "{{ secret_type }}"

  always:
    - name: Cleanup secrets
      import_tasks: ./targets/common/tasks/cleanup_secrets.yml
