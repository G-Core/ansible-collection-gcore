---
- vars:
    api_token: "{{ GCORE_API_TOKEN }}"
    api_host: "{{ GCORE_API_HOST }}"
    project_id: "{{ GCORE_PROJECT_ID }}"
    region_id: "{{ GCORE_REGION_ID }}"
    volume_name: "test_ansible_volume"
    snapshot_name: "test_ansible_snapshot"

  block:
    - name: Find volume by name
      gcore.cloud.volume_info:
        api_token: "{{ api_token }}"
        api_host: "{{ api_host }}"
        project_id: "{{ project_id }}"
        region_id: "{{ region_id }}"
        name_part: "{{ volume_name }}"
      register: find_volume
    
    - name: List snapshots before creation
      gcore.cloud.snapshot_info:
        api_token: "{{ api_token }}"
        api_host: "{{ api_host }}"
        project_id: "{{ project_id }}"
        region_id: "{{ region_id }}"
      register: list_result_before
    
    - name: Create new snapshot
      gcore.cloud.snapshot:
        api_token: "{{ api_token }}"
        api_host: "{{ api_host }}"
        project_id: "{{ project_id }}"
        region_id: "{{ region_id }}"
        command: create
        volume_id: "{{ find_volume.data[0]['id'] }}"
        name: "{{ snapshot_name }}"
      register: create_result
    
    - name: Verify task
      ansible.builtin.assert:
        that:
          - create_result.data["tasks"] | list | length == 1

    - name: Wait for snapshot
      ansible.builtin.pause:
        minutes: 2
    
    - name: List snapshots after creation
      gcore.cloud.snapshot_info:
        api_token: "{{ api_token }}"
        api_host: "{{ api_host }}"
        project_id: "{{ project_id }}"
        region_id: "{{ region_id }}"
      register: list_result_after

    - name: Check snapshot list length
      ansible.builtin.assert:
        that:
          - list_result_after.data | length == list_result_before.data | length + 1

    - name: Get snapshot by its volume id
      gcore.cloud.snapshot_info:
        api_token: "{{ api_token }}"
        api_host: "{{ api_host }}"
        project_id: "{{ project_id }}"
        region_id: "{{ region_id }}"
        volume_id: "{{ find_volume.data[0]['id'] }}"
      register: find_snapshot
    
    - name: Get volume by id
      gcore.cloud.volume_info:
        api_token: "{{ api_token }}"
        api_host: "{{ api_host }}"
        project_id: "{{ project_id }}"
        region_id: "{{ region_id }}"
        volume_id: "{{ find_volume.data[0]['id'] }}"
      register: find_volume
    
    - name: Validate volume's snapshots
      ansible.builtin.assert:
        that:
          - find_volume.data['snapshot_ids'] | list | length == 1
          - find_volume.data['snapshot_ids'][0] == find_snapshot.data[0]['id']
          - find_volume.data['id'] == find_snapshot.data[0]['volume_id']

  always:
    - name: Cleanup snapshots
      import_tasks: ./targets/common/tasks/cleanup_snapshots.yml
    - name: Cleanup volumes
      import_tasks: ./targets/common/tasks/cleanup_volumes.yml
