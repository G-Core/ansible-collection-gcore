---
- vars:
    api_token: "{{ GCORE_API_TOKEN }}"
    api_host: "{{ GCORE_API_HOST }}"
    project_id: "{{ GCORE_PROJECT_ID }}"
    region_id: "{{ GCORE_REGION_ID }}"

  block:
    - name: List all test instances
      gcore.cloud.instance_info:
        api_token: "{{ api_token }}"
        api_host: "{{ api_host }}"
        project_id: "{{ project_id }}"
        region_id: "{{ region_id }}"
      register: list_instances

    - name: Delete all test instances
      gcore.cloud.instance:
        api_token: "{{ api_token }}"
        api_host: "{{ api_host }}"
        project_id: "{{ project_id }}"
        region_id: "{{ region_id }}"
        command: delete
        instance_id: "{{ item.instance_id }}"
      when:
        - item.instance_name.startswith('test_ansible')
        - item.status != 'BUILD'
      with_items: "{{ list_instances.data }}"
      loop_control:
        label: "{{ item.instance_name }} ({{ item.instance_id }})"
